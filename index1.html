<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>O-Cell | نظام الطلب الذكي</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* ===================================================
           O-CELL — Radical theme: Lux Aurora (Burgundy + Gold)
           - Only CSS changed (background, colors, animations)
           - All JS / HTML structure left intact
           =================================================== */

        :root{
            /* NEW PALETTE */
            --bg-dark-1: #0c0710;    /* deepest */
            --bg-dark-2: #2a0b1f;    /* burgundy mid */
            --aurora-1:  #7b1fa2;    /* purple streak */
            --aurora-2:  #ff6b6b;    /* coral streak */
            --gold:      #ffd166;    /* accent gold */
            --gold-2:    #ffc857;
            --muted:     #cfc3c8;
            --card-glass: rgba(255,255,255,0.03);
            --glass-border: rgba(255,209,102,0.08);
            --text:      #fff6f8;
            --danger:    #ff5b5b;
            --shadow:    rgba(11,6,12,0.7);
            --radius-lg: 20px;
            --radius-md: 14px;
            --fast: 220ms;
            --slow: 520ms;
        }

        /* Reset / Base */
        *{ box-sizing: border-box; margin:0; padding:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
        html,body{ height:100%; }
        body{
            min-height:100vh;
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            color:var(--text);
            background: radial-gradient(1200px 600px at 10% 10%, rgba(255,209,102,0.03), transparent 8%),
                        radial-gradient(1000px 500px at 90% 90%, rgba(255,107,107,0.02), transparent 10%),
                        linear-gradient(180deg, var(--bg-dark-1) 0%, var(--bg-dark-2) 100%);
            overflow-x:hidden;
            line-height:1.58;
        }

        /* Animated aurora overlay using pseudo-element */
        body::before{
            content:"";
            position:fixed; inset:0; z-index: -1;
            background:
                radial-gradient(600px 240px at 10% 20%, rgba(123,31,162,0.14), transparent 20%),
                radial-gradient(520px 220px at 80% 70%, rgba(255,107,107,0.12), transparent 18%),
                linear-gradient(120deg, rgba(255,209,102,0.02), rgba(255,209,102,0.0));
            mix-blend-mode: screen;
            filter: blur(30px) saturate(120%);
            animation: auroraMove 14s linear infinite alternate;
            pointer-events: none;
        }

        @keyframes auroraMove{
            0%{ transform: translate3d(-6%, -2%, 0) scale(1.02) rotate(-2deg); opacity:0.95; }
            50%{ transform: translate3d(6%, 3%, 0) scale(1.06) rotate(2deg); opacity:1; }
            100%{ transform: translate3d(-4%, -1%, 0) scale(1.00) rotate(-1deg); opacity:0.96; }
        }

        /* Soft particulate / floating orbs */
        body::after{
            content:"";
            position:fixed; inset:0; z-index:-1;
            background-image:
                radial-gradient(circle at 12% 25%, rgba(255,209,102,0.06) 0 2px, transparent 8%),
                radial-gradient(circle at 70% 10%, rgba(255,107,107,0.04) 0 3px, transparent 10%),
                radial-gradient(circle at 50% 80%, rgba(123,31,162,0.05) 0 2px, transparent 8%);
            opacity:0.9;
            animation: orbsFloat 28s linear infinite;
            filter: blur(8px);
            pointer-events:none;
        }

        @keyframes orbsFloat{
            0%{ transform: translateY(0) scale(1); }
            50%{ transform: translateY(-18px) scale(1.03); }
            100%{ transform: translateY(0) scale(1); }
        }

        /* subtle entrance */
        @keyframes fadeUp { from{ opacity:0; transform: translateY(8px);} to{ opacity:1; transform:none;} }
        body > * { animation: fadeUp var(--slow) cubic-bezier(.2,.9,.2,1) both; }

        /* Navigation */
        .oc-contact-nav{
            position:sticky; top:0; z-index:1200; display:flex; align-items:center; justify-content:space-between;
            padding:12px 22px;
            background: linear-gradient(180deg, rgba(3,2,4,0.48), rgba(3,2,4,0.22));
            border-bottom: 1px solid rgba(255,255,255,0.02);
            backdrop-filter: blur(6px) saturate(120%);
        }
        .oc-contact-nav a{ color: var(--muted); text-decoration:none; font-weight:600; font-size:13px; transition: color var(--fast); }
        .oc-contact-nav a:hover{ color:var(--gold); }

        .profile-toggle{ display:none; font-size:20px; color:var(--text); cursor:pointer; }

        /* Sidebar */
        .oc-sidebar{
            position:fixed; top:0; right:-360px; width:340px; height:100%;
            background: linear-gradient(180deg, rgba(12,7,16,0.94), rgba(34,12,22,0.96));
            border-left: 1px solid var(--glass-border);
            padding:28px; display:flex; flex-direction:column; gap:12px;
            box-shadow: -30px 0 80px var(--shadow);
            transition: right 360ms cubic-bezier(.2,.9,.2,1);
            border-top-left-radius: 14px; border-bottom-left-radius: 14px;
        }
        .oc-sidebar.active{ right:0; }

        .sidebar-header h3{
            font-family:'Playfair Display', serif;
            color:var(--gold); font-size:1.45rem; letter-spacing:1px; margin-bottom:4px;
            text-shadow: 0 6px 24px rgba(255,209,102,0.06);
        }
        .sidebar-header p{ color:var(--muted); font-size:13px; }

        .profile-label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:6px; }
        .profile-value{ font-size:16px; color:var(--text); font-weight:700; }

        .status-badge{
            display:inline-block; padding:6px 14px; border-radius:999px; font-weight:800; font-size:12px;
            border:1px solid rgba(255,209,102,0.06); background: linear-gradient(90deg, rgba(255,209,102,0.03), rgba(255,209,102,0.01));
            color:var(--gold);
        }

        .logout-btn{
            margin-top:auto; width:100%; padding:12px; border-radius:14px; font-weight:800; cursor:pointer;
            background:transparent; color:var(--danger); border:1px solid rgba(255,82,82,0.08);
            display:flex; align-items:center; justify-content:center; gap:10px;
            transition: all var(--fast);
        }
        .logout-btn:hover{ background:var(--danger); color:white; border-color:transparent; box-shadow: 0 10px 40px rgba(255,82,82,0.06); }

        .close-sidebar{ position:absolute; top:16px; left:16px; color:var(--muted); font-size:20px; cursor:pointer; }

        /* Header */
        .oc-main-header{ padding:30px 0 8px; text-align:center; }
        .oc-neon-logo{
            font-family:'Playfair Display', serif;
            font-size:clamp(36px,6vw,56px); color:var(--text);
            letter-spacing:6px; font-weight:900; display:inline-block; padding:8px 14px; border-radius:12px;
            background: linear-gradient(90deg, rgba(255,209,102,0.03), rgba(255,255,255,0.01));
            box-shadow: 0 8px 40px rgba(10,4,10,0.6);
            position:relative; overflow:visible;
        }
        .oc-neon-logo span{ color:var(--gold); text-shadow: 0 6px 26px rgba(255,209,102,0.08); }

        /* Animated gold shimmer on logo */
        .oc-neon-logo::after{
            content:"";
            position:absolute; top:0; left:-30%; width:60%; height:100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.24), rgba(255,255,255,0.0));
            transform: skewX(-18deg);
            animation: shine 3.6s linear infinite;
            pointer-events:none;
            mix-blend-mode: overlay; opacity:0.9;
        }
        @keyframes shine { 0%{ left:-60% } 100%{ left:120% } }

        /* Hero card */
        .oc-hero-card{
            max-width:760px; margin:18px auto 28px; padding:38px 34px;
            border-radius:var(--radius-lg);
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border:1px solid rgba(255,209,102,0.03);
            box-shadow: 0 18px 60px rgba(6,4,8,0.6);
            text-align:center;
        }
        .oc-hero-card h2{ font-size:1.8rem; margin-bottom:6px; color:var(--text); font-weight:800; }
        .oc-hero-card p{ color:var(--muted); font-size:15px; }

        /* Container / Grid */
        .oc-container{ max-width:1180px; margin:20px auto 80px; padding:0 20px; }
        .oc-grid{
            display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:20px;
        }

        /* Product / Cat card (recolored) */
        .oc-glass-card{
            border-radius: var(--radius-md);
            overflow:hidden; cursor:pointer;
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
            border: 1px solid rgba(255,255,255,0.02);
            transition: transform var(--fast), box-shadow var(--fast), border-color var(--fast);
            transform-origin:center; display:flex; flex-direction:column; min-height:300px;
            box-shadow: 0 8px 30px rgba(6,3,8,0.6);
        }
        .oc-glass-card:hover{
            transform: translateY(-12px) scale(1.01);
            border-color: rgba(255,209,102,0.12);
            box-shadow: 0 30px 90px rgba(5,4,8,0.7);
        }
        .oc-glass-card img{ width:100%; height:200px; object-fit:cover; opacity:0.98; transition: transform 420ms ease, filter 420ms ease; filter: saturate(1.05) contrast(1.02); }
        .oc-glass-card:hover img{ transform: scale(1.04); filter: saturate(1.08) contrast(1.06) brightness(1.02); }

        .oc-card-body{ padding:18px; text-align:center; display:flex; flex-direction:column; gap:8px; margin-top:auto; }
        .oc-card-body h3{ font-size:16px; font-weight:800; color:var(--text); }
        .oc-card-body .price{ color:var(--gold); font-weight:900; font-size:1.1rem; }

        .sold-badge{
            position:absolute; top:14px; left:14px; background:#6d1017; color:#ffd6d6;
            padding:6px 10px; border-radius:8px; font-size:11px; font-weight:900; z-index:4;
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }

        /* Modal (recolor) */
        .oc-modal{
            display:none; position:fixed; inset:0; z-index:5000;
            background: linear-gradient(180deg, rgba(8,6,8,0.76), rgba(8,6,10,0.92));
            justify-content:center; align-items:center; padding:22px;
        }
        .oc-modal-content{
            width:100%; max-width:540px; border-radius:20px; padding:28px;
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
            border:1px solid rgba(255,209,102,0.04); backdrop-filter: blur(8px);
            box-shadow: 0 30px 90px rgba(6,3,8,0.7); text-align:center;
        }
        .oc-modal-content img{ width:100%; height:260px; object-fit:cover; border-radius:14px; margin-bottom:16px; border:1px solid rgba(255,255,255,0.03); }

        .qty-container{ display:flex; align-items:center; justify-content:center; gap:14px; margin:20px 0; }
        .qty-label{ color:var(--muted); font-size:13px; text-transform:uppercase; letter-spacing:1px; }
        .qty-controls{ display:flex; align-items:center; background: rgba(255,255,255,0.01); border-radius:12px; border:1px solid rgba(255,255,255,0.02); overflow:hidden; }
        .qty-btn{ padding:10px 16px; border:none; background:transparent; cursor:pointer; font-size:18px; font-weight:800; color:var(--gold-2); }
        .qty-input{ width:48px; text-align:center; border:none; background:transparent; color:var(--text); font-weight:900; font-size:16px; }

        .wa-btn{
            display:block; text-decoration:none; font-weight:900; padding:14px 18px;
            border-radius:14px; background: linear-gradient(90deg, var(--gold), #ffb857);
            color:#2b1200; box-shadow: 0 18px 60px rgba(255,209,102,0.08); transition: transform var(--fast);
        }
        .wa-btn:hover{ transform: translateY(-6px); opacity:0.98; }

        .back-btn{ display:inline-block; margin-bottom:28px; padding:10px 22px; border-radius:999px; border:1px solid rgba(255,209,102,0.06); color:var(--gold); background:transparent; font-weight:800; }

        /* Floating login button (recolor to match new theme) */
        .login-float{
            position:fixed; bottom:26px; right:26px; width:64px; height:64px; z-index:2000;
            border-radius:50%; display:flex; align-items:center; justify-content:center;
            background: linear-gradient(180deg, #fff6e8, #fff0d6); color:#2b1200;
            box-shadow: 0 16px 60px rgba(43,18,0,0.18);
            border: 3px solid rgba(255,209,102,0.14); cursor:pointer; transition: transform var(--fast);
        }
        .login-float:hover{ transform: translateY(-6px) scale(1.03); }

        /* Profile overlay */
        #profileOverlay{
            display:none; position:fixed; inset:0; z-index:9999;
            background: radial-gradient(circle at 50% 30%, rgba(123,31,162,0.12), transparent 8%), rgba(6,3,6,0.8);
            justify-content:center; align-items:center; padding:20px;
        }
        .login-box{
            max-width:420px; width:100%; padding:34px; border-radius:18px;
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));
            border:1px solid rgba(255,209,102,0.04); text-align:center; backdrop-filter: blur(6px);
        }
        .login-input{ width:100%; padding:14px; margin:8px 0; border-radius:12px; border:none; background: rgba(255,255,255,0.01); color:var(--text); text-align:center; font-weight:600; }
        .login-btn{ margin-top:10px; width:100%; padding:12px; border-radius:12px; border:none; cursor:pointer; background: linear-gradient(90deg,var(--gold),var(--gold-2)); color:#2b1200; font-weight:900; }

        .hidden{ display:none !important; }

        /* Responsive tweaks */
        @media (max-width:720px){
            .oc-sidebar{ width:92%; right:-100%; }
            .oc-sidebar.active{ right:0; }
            .oc-hero-card{ padding:22px; margin:12px 16px 22px; border-radius:16px; }
            .oc-glass-card{ min-height:260px; }
            .oc-glass-card img{ height:160px; }
            .oc-modal-content img{ height:200px; }
            .profile-toggle{ display:block; }
            .oc-contact-nav a{ font-size:12px; }
            .oc-container{ padding:0 14px; }
        }

        /* reduced motion */
        @media (prefers-reduced-motion: reduce){
            *{ animation:none !important; transition:none !important; }
        }

    </style>

</head>
<body>  <div id="loginBtnContainer" class="login-float" onclick="loginWithGoogle()">
    <i class="fab fa-google"></i>
</div>

<div id="profileOverlay">
    <div class="login-box">
        <h2 style="margin-bottom:20px; color:var(--gold);">إكمال التسجيل</h2>
        <p style="margin-bottom:20px; font-size:13px; opacity:0.85;">أهلاً بك! يرجى إدخال اسمك ورقم هاتفك لمرة واحدة فقط</p>
        <input type="text" id="profName" class="login-input" placeholder="الاسم الكامل">
        <input type="tel" id="profPhone" class="login-input" placeholder="رقم الهاتف">
        <button class="login-btn" onclick="saveProfileData()">حفظ ومتابعة</button>
    </div>
</div>

<div id="accountSidebar" class="oc-sidebar">
    <div class="close-sidebar" onclick="toggleSidebar()">&times;</div>

    <div class="sidebar-header">
        <h3>حسابي</h3>
        <p>بياناتك الشخصية</p>
    </div>

    <div class="profile-info-item">
        <span class="profile-label">الاسم</span>
        <span class="profile-value" id="sideName">---</span>
    </div>

    <div class="profile-info-item">
        <span class="profile-label">رقم الهاتف</span>
        <span class="profile-value" id="sidePhone">---</span>
    </div>

    <div class="profile-info-item">
        <span class="profile-label">حالة الحساب</span>
        <span id="sideStatus" class="status-badge status-retail">زبون مفرق</span>
    </div>

    <button class="logout-btn" onclick="logoutUser()">
        <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
    </button>
</div>

<div class="oc-contact-nav">
    <div class="profile-toggle" id="navProfileIcon" onclick="toggleSidebar()">
        <i class="fas fa-user-circle"></i>
    </div>
    <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
        <a href="tel:78961175" style="margin-left:15px;"><i class="fas fa-phone"></i> 78961175</a>
        <a href="https://maps.app.goo.gl/EJoXedJGapY6u3jKA" target="_blank" style="display:inline-flex; align-items:center;"><i class="fas fa-map-marker-alt" style="margin-left:6px;"></i> بيروت خط المشرفية الشياح- شارع كنج وعيتاني بجانب قهوة ابو حسن</a>
    </div>
</div>

<header class="oc-main-header">
    <h1 class="oc-neon-logo">O-<span>CELL</span></h1>
</header>

<div id="vHome">
    <div class="oc-hero-card">
        <h2>O-Cell Lebanon</h2>
        <p>اخترنا لك الأفضل في عالم التكنولوجيا</p>
    </div>
    <div class="oc-container">
        <h3 style="color: var(--gold); margin-bottom: 30px; border-right: 4px solid var(--gold); padding-right: 15px;">الفئات</h3>
        <div class="oc-grid" id="catGrid"></div>
    </div>
</div>

<div id="vProd" class="hidden oc-container">
    <button class="back-btn" onclick="goBack()">← العودة للأقسام</button>
    <h2 id="viewCatTitle" style="text-align:center; color:white; font-size: 2.2rem; margin-bottom: 35px;"></h2>
    <div class="oc-grid" id="prodGrid"></div>
</div>

<div id="modal" class="oc-modal" onclick="if(event.target==this) goBack()">
    <div class="oc-modal-content">
        <img id="mImg" src="">
        <h2 id="mTitle" style="margin-bottom: 10px;"></h2>
        <p id="mDesc" style="color: var(--muted); font-size: 13px; margin-bottom: 15px;"></p>
        <div id="mPrice" style="font-size:32px; color:var(--gold); font-weight:900;"></div>

        <div class="qty-container">
            <span class="qty-label">الكمية:</span>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateQty(-1)">-</button>
                <input type="number" id="qtyInput" class="qty-input" value="1" readonly>
                <button class="qty-btn" onclick="updateQty(1)">+</button>
            </div>
        </div>

        <div id="waAction"></div>
        <button onclick="goBack()" style="background:none; border:none; color:white; margin-top:20px; cursor:pointer; opacity:0.6;">إغلاق</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, query, where, setDoc, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCnzm7b0mEiszDck9d_KvOfVMN2WguQs8w",
        authDomain: "o-cell-8bd7f.firebaseapp.com",
        projectId: "o-cell-8bd7f",
        storageBucket: "o-cell-8bd7f.firebasestorage.app",
        messagingSenderId: "123702658364",
        appId: "1:123702658364:web:f51ca179843af7bab24a39",
        measurementId: "G-9G5Y056X75"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const STORE_PHONE = "96178961175";

    let productMemory = [];
    let activeProduct = null;
    let currentUserRole = 'retail';
    let currentUserEmail = null;

    // --- 1. تسجيل الدخول ---
    window.loginWithGoogle = () => {
        signInWithPopup(auth, provider)
            .then((result) => {
                const user = result.user;
                currentUserEmail = user.email;
                monitorUserStatus(user.email, user.displayName);
            }).catch((error) => {
                console.error("Login Failed", error);
                alert("فشل تسجيل الدخول.");
            });
    };

    // --- 2. المراقبة الحية وتحديث الواجهة ---
    function monitorUserStatus(email, displayName) {
        const q = query(collection(db, "users"), where("email", "==", email));

        onSnapshot(q, (snapshot) => {
            if (!snapshot.empty) {
                // المستخدم موجود
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const oldRole = currentUserRole;
                    currentUserRole = data.role || 'retail';

                    // حفظ البيانات
                    localStorage.setItem('oc_user', JSON.stringify({
                        name: data.name, phone: data.phone, role: currentUserRole, email: email
                    }));

                    // تحديث واجهة الحساب الجانبية
                    updateSidebar(data.name, data.phone, currentUserRole);

                    // إخفاء زر التسجيل وإظهار أيقونة البروفايل
                    document.getElementById('loginBtnContainer').style.display = 'none';
                    document.getElementById('navProfileIcon').style.display = 'block';

                    // تحديث الأسعار إذا تغيرت الرتبة
                    if (oldRole !== currentUserRole) {
                        const currentCat = document.getElementById('viewCatTitle').innerText;
                        if(!document.getElementById('vProd').classList.contains('hidden') && currentCat) {
                            fetchProducts(currentCat);
                        }
                    }
                });
            } else {
                // مستخدم جديد -> إظهار نافذة إكمال البيانات
                document.getElementById('profName').value = displayName || "";
                document.getElementById('profileOverlay').style.display = 'flex';
            }
        });
    }

    function updateSidebar(name, phone, role) {
        document.getElementById('sideName').innerText = name;
        document.getElementById('sidePhone').innerText = phone || "غير مسجل";
        const statusBadge = document.getElementById('sideStatus');

        if(role === 'wholesale') {
            statusBadge.innerText = "تاجر جملة";
            statusBadge.className = "status-badge status-wholesale";
        } else {
            statusBadge.innerText = "زبون مفرق";
            statusBadge.className = "status-badge status-retail";
        }
    }

    // --- 3. حفظ بيانات المستخدم الجديد ---
    window.saveProfileData = async () => {
        const name = document.getElementById('profName').value;
        const phone = document.getElementById('profPhone').value;

        if(!name || !phone) return alert("الرجاء إدخال البيانات");

        try {
            await addDoc(collection(db, "users"), {
                email: currentUserEmail,
                name: name,
                phone: phone,
                role: 'retail',
                joined: new Date()
            });
            document.getElementById('profileOverlay').style.display = 'none';
            alert("تم التسجيل بنجاح!");
        } catch (e) {
            console.error("Error: ", e);
        }
    };

    // --- 4. القائمة الجانبية وتسجيل الخروج ---
    window.toggleSidebar = () => {
        document.getElementById('accountSidebar').classList.toggle('active');
    };

    window.logoutUser = () => {
        if(confirm("هل أنت متأكد من تسجيل الخروج؟")) {
            signOut(auth).then(() => {
                localStorage.removeItem('oc_user');
                location.reload(); // إعادة تحميل الصفحة لتعود لوضع الزائر
            });
        }
    };

    // التحقق عند فتح الصفحة
    const savedUser = localStorage.getItem('oc_user');
    if(savedUser) {
        const userObj = JSON.parse(savedUser);
        currentUserEmail = userObj.email;
        currentUserRole = userObj.role;
        monitorUserStatus(userObj.email, userObj.name);
    } else {
        // حالة الزائر
        document.getElementById('loginBtnContainer').style.display = 'flex';
        document.getElementById('navProfileIcon').style.display = 'none';
    }

    window.addEventListener('popstate', (e) => {
        if (e.state && e.state.v === 'p') renderProductsView(e.state.n, false);
        else { renderHomeView(); closeM(); }
    });

    async function initStore() {
        const snap = await getDocs(collection(db, "categories"));
        const grid = document.getElementById('catGrid');
        grid.innerHTML = "";
        snap.forEach(d => {
            const c = d.data();
            grid.innerHTML += `
                <div class="oc-glass-card" onclick="navToCat('${c.name}')">
                    <img src="${c.image}">
                    <div class="oc-card-body"><h3>${c.name}</h3></div>
                </div>`;
        });
    }

    window.navToCat = (n) => {
        history.pushState({v:'p', n:n}, "");
        renderProductsView(n);
    };

    function renderProductsView(n) {
        document.getElementById('vHome').classList.add('hidden');
        document.getElementById('vProd').classList.remove('hidden');
        document.getElementById('viewCatTitle').innerText = n;
        fetchProducts(n);
    }

    async function fetchProducts(catName) {
        const grid = document.getElementById('prodGrid');
        grid.innerHTML = "<p style='grid-column: 1/-1; text-align:center;'>جاري تحميل الأسعار...</p>";
        const snap = await getDocs(collection(db, "products"));
        grid.innerHTML = "";
        productMemory = [];
        let i = 0;
        snap.forEach(d => {
            const p = d.data();
            if(p.category === catName) {
                productMemory.push(p);
                const finalPrice = currentUserRole === 'wholesale' ? (p.priceWholesale || p.price) : p.price;

                grid.innerHTML += `
                    <div class="oc-glass-card" onclick="openDetails(${i})">
                        ${!p.inStock ? '<div class="sold-badge">نافذ</div>' : ''}
                        <img src="${p.image}">
                        <div class="oc-card-body">
                            <h3>${p.name}</h3>
                            <div class="price">$${finalPrice}</div>
                        </div>
                    </div>`;
                i++;
            }
        });
    }

    window.openDetails = (index) => {
        activeProduct = productMemory[index];
        const finalPrice = currentUserRole === 'wholesale' ? (activeProduct.priceWholesale || activeProduct.price) : activeProduct.price;
        activeProduct.displayPrice = finalPrice;

        document.getElementById('qtyInput').value = 1;

        history.pushState({v:'m'}, "");
        document.getElementById('mImg').src = activeProduct.image;
        document.getElementById('mTitle').innerText = activeProduct.name;
        document.getElementById('mDesc').innerText = activeProduct.description || "";
        document.getElementById('mPrice').innerText = "$" + finalPrice;

        updateWALink();
        document.getElementById('modal').style.display = "flex";
    };

    window.updateQty = (val) => {
        let current = parseInt(document.getElementById('qtyInput').value);
        let next = current + val;
        if(next < 1) return;
        document.getElementById('qtyInput').value = next;
        updateWALink();
    };

    function updateWALink() {
        if(!activeProduct) return;
        const qty = document.getElementById('qtyInput').value;
        const total = (parseFloat(activeProduct.displayPrice) * parseInt(qty)).toFixed(2);

        const userType = currentUserRole === 'wholesale' ? '(سعر جملة)' : '';
        const msg = encodeURIComponent(`مرحباً O-Cell، أود طلب:\n- المنتج: ${activeProduct.name}\n- الكمية: ${qty}\n- السعر الإجمالي: $${total} ${userType}`);

        const area = document.getElementById('waAction');
        area.innerHTML = activeProduct.inStock ?
            `<a href="https://wa.me/${STORE_PHONE}?text=${msg}" target="_blank" class="wa-btn">اطلب الآن عبر WHATSAPP</a>` :
            `<div class="wa-btn" style="background:#555; box-shadow:none;">غير متوفر حالياً</div>`;
    }

    window.goBack = () => history.back();
    function renderHomeView() { document.getElementById('vHome').classList.remove('hidden'); document.getElementById('vProd').classList.add('hidden'); }
    function closeM() { document.getElementById('modal').style.display = "none"; activeProduct = null; }

    initStore();
</script>

</body>
</html>
