<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>O-Cell | Admin Console</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
</head>
<body style="background: #f0f2f5; color: #1a1a2e; padding: 40px;">

<div class="wrapper" style="max-width: 900px;">
    <div class="admin-card">
        <h3><i class="fas fa-folder-plus"></i> إدارة الهيكلية (Categories)</h3>
        <input type="text" id="cName" class="admin-input" placeholder="اسم القسم الجديد">
        <input type="text" id="cImg" class="admin-input" placeholder="رابط صورة القسم (ImgBB)">
        <button onclick="saveCategory()" class="admin-btn">تأكيد وحفظ القسم</button>
    </div>

    <div class="admin-card">
        <h3><i class="fas fa-plus-circle"></i> إدراج منتج جديد</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <input type="text" id="pName" class="admin-input" placeholder="اسم المنتج">
            <select id="pCatList" class="admin-input"><option value="">اختر القسم...</option></select>
            <input type="number" id="pPrice" class="admin-input" placeholder="السعر ($)">
            <input type="text" id="pImg" class="admin-input" placeholder="رابط صورة المنتج">
        </div>
        <textarea id="pDesc" class="admin-input" placeholder="وصف المنتج التفصيلي..." rows="4"></textarea>
        <button onclick="saveProduct()" class="admin-btn">نشر في المتجر العام</button>
    </div>

    <div class="admin-card">
        <h3><i class="fas fa-warehouse"></i> جرد المخزون الفعلي</h3>
        <div id="inventoryContainer"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCnzm7b0mEiszDck9d_KvOfVMN2WguQs8w",
        authDomain: "o-cell-8bd7f.firebaseapp.com",
        projectId: "o-cell-8bd7f",
        storageBucket: "o-cell-8bd7f.firebasestorage.app",
        messagingSenderId: "123702658364",
        appId: "1:123702658364:web:f51ca179843af7bab24a39"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.saveCategory = async () => {
        const data = { name: document.getElementById('cName').value, image: document.getElementById('cImg').value };
        await addDoc(collection(db, "categories"), data);
        alert("تم تحديث الأقسام بنجاح.");
        location.reload();
    };

    async function initialize() {
        const snap = await getDocs(collection(db, "categories"));
        const select = document.getElementById('pCatList');
        snap.forEach(d => select.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`);
        refreshInventory();
    }

    window.saveProduct = async () => {
        const product = {
            name: document.getElementById('pName').value,
            category: document.getElementById('pCatList').value,
            price: document.getElementById('pPrice').value,
            image: document.getElementById('pImg').value,
            description: document.getElementById('pDesc').value,
            inStock: true,
            createdAt: new Date()
        };
        await addDoc(collection(db, "products"), product);
        alert("تمت الإضافة للمتجر.");
        refreshInventory();
    };

    window.refreshInventory = async () => {
        const snap = await getDocs(collection(db, "products"));
        const box = document.getElementById('inventoryContainer');
        box.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            box.innerHTML += `
                <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #eee;">
                    <span><b>${p.name}</b> ($${p.price})</span>
                    <div>
                        <button onclick="toggleStockStatus('${d.id}', ${p.inStock})" style="background:${p.inStock?'#10b981':'#64748b'}; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">${p.inStock?'متوفر':'نافذ'}</button>
                        <button onclick="removeProduct('${d.id}')" style="background:#ef4444; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; margin-right:5px;">حذف</button>
                    </div>
                </div>`;
        });
    };

    window.toggleStockStatus = async (id, current) => { await updateDoc(doc(db, "products", id), { inStock: !current }); refreshInventory(); };
    window.removeProduct = async (id) => { if(confirm("هل أنت متأكد؟")) { await deleteDoc(doc(db, "products", id)); refreshInventory(); } };

    initialize();
</script>
</body>
</html>
