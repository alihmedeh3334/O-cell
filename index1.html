<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#004c8c">
    
    <title>O-Cell Store | التميز في التكنولوجيا</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:ital,wght@0,700;0,900;1,700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="oc-top-bar">
        <div class="oc-container inner-nav" style="padding: 0 10px;">
            <a href="tel:+96178961175">
                <i class="fas fa-phone-alt"></i> اتصل بنا الآن: 78961175
            </a>
            <a href="https://maps.app.goo.gl/EJoXedJGapY6u3jKA" target="_blank">
                <i class="fas fa-map-marker-alt"></i> بيروت، لبنان - المشرفية
            </a>
        </div>
    </div>

    <header class="oc-header">
        <div class="oc-container logo-container" style="padding: 0;">
            <h1 class="brand-font">O-<span>CELL</span></h1>
        </div>
    </header>

    <main>
        
        <section id="viewHome">
            <div class="oc-hero">
                <h2>نحن نصنع التميز <span>التقني</span></h2>
                <p>مرحباً بكم في متجر O-Cell الرسمي. تصفحوا مجموعتنا المختارة من الشواحن، الوصلات، وأرقى الإكسسوارات التقنية بجودة عالمية.</p>
                <div class="oc-delivery-pill">
                    توصيل سريع لجميع المناطق اللبنانية <i class="fas fa-truck-fast"></i>
                </div>
            </div>

            <div class="oc-container">
                <h3 class="oc-section-title">تصفح مجموعاتنا</h3>
                <div class="oc-grid" id="categoryContainer">
                    </div>
            </div>
        </section>

        <section id="viewProducts" class="hidden">
            <div class="oc-container">
                <div style="padding: 20px 0;">
                    <button class="oc-btn-back" onclick="executeBackAction()">
                        <i class="fas fa-arrow-right"></i> العودة للأقسام
                    </button>
                </div>
                
                <h2 id="currentCategoryTitle" class="oc-section-title" style="text-align: center;">جاري التحميل...</h2>
                
                <div class="oc-grid" id="productContainer">
                    </div>
            </div>
        </section>

    </main>

    <footer style="background: white; padding: 40px 20px; text-align: center; border-top: 1px solid #eee;">
        <h4 class="brand-font" style="color: #004c8c; font-size: 1.5rem;">O-CELL</h4>
        <p style="color: #94a3b8; font-size: 13px; margin-top: 10px;">&copy; 2026 جميع الحقوق محفوظة لمتجر O-Cell. التميز والاحترافية.</p>
    </footer>

    <div id="productModal" class="oc-modal" onclick="if(event.target==this) executeBackAction()">
        <div class="oc-modal-box">
            <img id="mImg" src="" alt="Product Detail Image">
            <h2 id="mTitle" class="brand-font">اسم المنتج الفاخر</h2>
            <p id="mDesc">وصف المنتج سيظهر هنا بالتفصيل ليشرح مميزات القطعة التقنية المختارة.</p>
            <span id="mPrice" class="oc-price-large">$0.00</span>
            
            <div id="waActionWrapper">
                </div>
            
            <button onclick="executeBackAction()" style="background:none; border:none; color:#94a3b8; margin-top:25px; cursor:pointer; font-weight:700; font-size:12px;">
                إغلاق النافذة
            </button>
        </div>
    </div>

    <script type="module">
        /* --- 6.1 FIREBASE INITIALIZATION --- */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Your Firebase configuration precisely integrated
        const firebaseConfig = {
            apiKey: "AIzaSyCnzm7b0mEiszDck9d_KvOfVMN2WguQs8w",
            authDomain: "o-cell-8bd7f.firebaseapp.com",
            projectId: "o-cell-8bd7f",
            storageBucket: "o-cell-8bd7f.firebasestorage.app",
            messagingSenderId: "123702658364",
            appId: "1:123702658364:web:f51ca179843af7bab24a39"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const STORE_PHONE = "96178961175";

        /* --- 6.2 HISTORY API & STATE MANAGEMENT --- */
        // Listen for browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.view === 'products') {
                renderProductsView(event.state.name, false);
            } else if (event.state && event.state.view === 'modal') {
                // Keep modal handled separately
            } else {
                renderHomeView(false);
                hideModal();
            }
        });

        /* --- 6.3 CORE RENDER FUNCTIONS --- */

        // Step 1: Load Initial Categories
        async function fetchAllCategories() {
            const catContainer = document.getElementById('categoryGrid'); // Fixed from catGrid to categoryContainer
            const grid = document.getElementById('categoryContainer');
            
            try {
                const querySnapshot = await getDocs(collection(db, "categories"));
                grid.innerHTML = ""; // Clear loader
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const cardHtml = `
                        <div class="oc-card" onclick="initiateCategoryTransition('${data.name}')">
                            <div class="img-wrapper">
                                <img src="${data.image}" alt="${data.name}">
                            </div>
                            <div class="card-content">
                                <h3>${data.name}</h3>
                            </div>
                        </div>
                    `;
                    grid.innerHTML += cardHtml;
                });
            } catch (error) {
                console.error("Firebase Category Loading Error: ", error);
            }
        }

        // Step 2: Navigate to Category
        window.initiateCategoryTransition = (categoryName) => {
            history.pushState({view: 'products', name: categoryName}, "");
            renderProductsView(categoryName);
        };

        // Step 3: Render Products View
        function renderProductsView(categoryName) {
            document.getElementById('viewHome').classList.add('hidden');
            document.getElementById('viewProducts').classList.remove('hidden');
            document.getElementById('currentCategoryTitle').innerText = categoryName;
            fetchCategoryProducts(categoryName);
        }

        // Step 4: Fetch Products from DB
        async function fetchCategoryProducts(categoryName) {
            const productGrid = document.getElementById('productContainer');
            productGrid.innerHTML = "<p style='grid-column: 1/-1; text-align:center;'>جاري سحب المخزون الفعلي من O-Cell...</p>";
            
            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                productGrid.innerHTML = "";
                
                querySnapshot.forEach((doc) => {
                    const p = doc.data();
                    if (p.category === categoryName) {
                        const productCard = `
                            <div class="oc-card" onclick="triggerProductDetails('${p.name}', '${p.image}', '${p.description}', '${p.price}', ${p.inStock})">
                                ${!p.inStock ? '<div class="stock-badge">نفذ المخزون</div>' : ''}
                                <div class="img-wrapper">
                                    <img src="${p.image}" alt="${p.name}">
                                </div>
                                <div class="card-content">
                                    <h3>${p.name}</h3>
                                    <span class="price-display">$${p.price}</span>
                                </div>
                            </div>
                        `;
                        productGrid.innerHTML += productCard;
                    }
                });
            } catch (error) {
                console.error("Firebase Product Loading Error: ", error);
            }
        }

        // Step 5: Product Details Modal
        window.triggerProductDetails = (name, img, desc, price, inStock) => {
            history.pushState({view: 'modal'}, "");
            document.getElementById('mImg').src = img;
            document.getElementById('mTitle').innerText = name;
            document.getElementById('mDesc').innerText = desc;
            document.getElementById('mPrice').innerText = "$" + price;
            
            const waLink = `https://wa.me/${STORE_PHONE}?text=${encodeURIComponent('مرحباً O-Cell، أود طلب هذه القطعة: ' + name + ' - السعر: $' + price)}`;
            const actionContainer = document.getElementById('waActionWrapper');
            
            if (inStock) {
                actionContainer.innerHTML = `<a href="${waLink}" class="oc-btn-whatsapp">اطلب الآن عبر واتساب <i class="fab fa-whatsapp"></i></a>`;
            } else {
                actionContainer.innerHTML = `<div class="oc-btn-whatsapp oc-btn-out">عذراً، هذا المنتج غير متوفر حالياً</div>`;
            }
            
            document.getElementById('productModal').classList.add('visible');
        };

        // Step 6: Navigation Helper
        function renderHomeView() {
            document.getElementById('viewHome').classList.remove('hidden');
            document.getElementById('viewProducts').classList.add('hidden');
        }

        window.executeBackAction = () => {
            history.back();
        };

        function hideModal() {
            document.getElementById('productModal').classList.remove('visible');
        }

        // Initialize Engine
        fetchAllCategories();

    </script>
</body>
</html>
